{% extends 'base.html' %}
{% load static %}
{% block title %}–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ IMEI | IMEI Scanner{% endblock %}
{% block head_extra %}
    <!-- –õ–û–ö–ê–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö–ò -->
    <script src="{% static 'js/html5-qrcode.min.js' %}"></script>
    
    <style>
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #reader video {
            width: 100%;
            border-radius: 10px;
            border: 2px solid #007bff;
        }
        
        .scanner-container {
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 15px;
            background: #f8f9fa;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scanner-placeholder {
            text-align: center;
            color: #6c757d;
        }
        
        @keyframes flashAnimation {
            0% { opacity: 0.7; }
            100% { opacity: 0; }
        }
        
        .scanned-item {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
{% endblock %}
{% block content %}
{% csrf_token %}

<div class="row justify-content-center">
    <div class="col-12 col-lg-8">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="card-title mb-3">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ IMEI</h5>
                <p class="text-muted">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ, –Ω–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ –∏–ª–∏ QR-–∫–æ–¥ —Å IMEI.</p>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ -->
                <div id="reader" class="scanner-container">
                    <div class="scanner-placeholder" id="scannerPlaceholder">
                        <div class="mb-3" style="font-size: 3rem;">üì±</div>
                        <p>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã</p>
                    </div>
                </div>
                
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-success btn-lg" id="startScanBtn">
                        üé• –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                    </button>
                    <button class="btn btn-outline-secondary" id="stopScanBtn" disabled>
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                    </button>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å —Å–∫–∞–Ω–µ—Ä–∞ -->
                <div id="scannerStatus" class="mt-3"></div>
            </div>
        </div>
        
        <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ IMEI -->
        <div class="card shadow-sm border-0 mt-4">
            <div class="card-body">
                <h6 class="card-title">‚úçÔ∏è –†—É—á–Ω–æ–π –≤–≤–æ–¥ IMEI</h6>
                <form id="manualImeiForm" class="d-flex gap-2">
                    <input type="text" 
                           id="manualImei" 
                           class="form-control" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ 15-–∑–Ω–∞—á–Ω—ã–π IMEI"
                           maxlength="15"
                           pattern="[0-9]{15}"
                           title="IMEI –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 15 —Ü–∏—Ñ—Ä">
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </form>
                <small class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—Å–ª–∏ —Å–∫–∞–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</small>
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IMEI -->
        <div class="card shadow-sm border-0 mt-4">
            <div class="card-body">
                <h6 class="card-title">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è</h6>
                <div id="scannedList">
                    <div class="text-center text-muted py-4" id="emptyState">
                        <div class="mb-2" style="font-size: 2rem;">üìÑ</div>
                        –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ IMEI –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deviceConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="confirmDeviceForm">
                <div class="modal-header">
                    <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small" id="lookupStatus" hidden></div>
                    <div class="mb-3">
                        <label class="form-label">IMEI</label>
                        <input type="text" class="form-control" id="modalImei" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ú–æ–¥–µ–ª—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                        <input type="text" class="form-control" id="modalModel" placeholder="(–ë—Ä–µ–Ω–¥) - –ú–æ–¥–µ–ª—å">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" id="modalStatus">
                            {% for value, label in statuses %}
                                <option value="{{ value }}" {% if value == default_status %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea class="form-control" id="modalComment" rows="3" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="text-danger small me-auto" id="modalError" hidden></span>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        window.SCANNER_ENDPOINTS = {
            lookup: "{% url 'imei_lookup' %}",
            add: "{% url 'add_from_scan' %}"
        };
    </script>
    <script src="{% static 'js/imeicheck.js' %}"></script>
    <script src="{% static 'js/scanner.js' %}"></script>
{% endblock %}